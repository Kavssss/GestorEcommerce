package backend.repositories.item;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import backend.entities.ItemEntity;
import models.DAO;
import models.DbException;

public class ItemRepositoryImpl extends DAO implements ItemRepository {

	PreparedStatement preparedStatement;
	ResultSet resultSet;
	
	@Override
	public ItemEntity findById(Long id) throws SQLException {
		String sql = "SELECT * FROM TB_ITEM WHERE ID_ITEM = ?";
		try {
    		this.conectar();
   		 	preparedStatement = this.conexao.prepareStatement(sql);
   		 	preparedStatement.setLong(1, id);
		 	System.out.println(preparedStatement.toString());
   		 	resultSet = preparedStatement.executeQuery();
   		 	return resultSetToItem(resultSet);
        } catch (SQLException e) {
       	 	throw new DbException(e.getMessage());
        }
	}
	
	private ItemEntity resultSetToItem(ResultSet resultSet) throws SQLException {
		ItemEntity item = null;
		if (resultSet.next())
			item = new ItemEntity(
					resultSet.getLong("ID_ITEM"),
					resultSet.getString("COD_ITEM"),
					resultSet.getInt("QTDE"),
					resultSet.getDouble("VALOR_UNITARIO"),
					resultSet.getDouble("VALOR_TOTAL"),
					resultSet.getDouble("VALOR_RECEBIDO"),
					resultSet.getString("DESCRICAO"));
    	this.desconectar(this.conexao);
    	return item != null ? item : null;
    }

	@Override
	public void insertItem(String codItem, String descricao) throws SQLException {
		StringBuilder sql = new StringBuilder("INSERT INTO TB_ITEM(COD_ITEM, MODELO, VARIACAO, DESCRICAO) ");
		sql.append(" VALUES(?, ?, ?, ?)");
		try {
			this.conectar();
			preparedStatement = this.conexao.prepareStatement(sql.toString());
			preparedStatement.setString(1, codItem);
			preparedStatement.setString(2, codItem.split("-")[0]);
			preparedStatement.setString(3, codItem.split("-")[1]);
			preparedStatement.setString(4, descricao);
			System.out.println(preparedStatement.toString());
			preparedStatement.executeUpdate();
		} catch (SQLException e) {
			throw new DbException(e.getMessage());
		}
	}

	@Override
	public void editItem(Long id, String codItem, String descricao) throws SQLException {
		StringBuilder sql = new StringBuilder("UPDATE TB_ITEM SET COD_ITEM = ?, MODELO = ?, VARIACAO = ?, DESCRICAO = ?");
		sql.append(" WHERE ID_VENDA = ?");
		try {
			this.conectar();
			preparedStatement = this.conexao.prepareStatement(sql.toString());
			preparedStatement.setString(1, codItem);
			preparedStatement.setString(2, codItem.split("-")[0]);
			preparedStatement.setString(3, codItem.split("-")[1]);
			preparedStatement.setString(4, descricao);
			System.out.println(preparedStatement.toString());
			preparedStatement.executeUpdate();
		} catch (SQLException e) {
			throw new DbException(e.getMessage());
		}
		
	}

}
